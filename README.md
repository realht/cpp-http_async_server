# Web сервер для онлайн игры
Моя часть проекта – backend часть сервера, которая отвечала за игровую механику, взаимодействие с игровыми объектами, ведение статистики и поддержание безопасности и надежной работы самого сервера. Коллеги же предоставили [Frontend часть](https://drive.google.com/file/d/1NRO0lTlTWYMLhmFHbUE-p38AQ7G7bxyG/view?usp=sharing) и отвечали за нее. Сам сервер, который был написан с применением библиотеки Boost, принимал и обрабатывал запросы асинхронно в многопоточном режиме. Взаимодействие frontend и backend осуществлялась согласно REST API (по http протоколу). На запросы сервера передавал сформированные JSON.
Проект был написан на C++20 под CMake и запускался в Docker на ВМ Linux (Ubuntu 22.04). Основные модули проекты покрыты тестами Boost.Test, Google Test и Catch2. Запросы к базе данных PostgreSQL выполнялись через транзакции. Запросы к серверу логировались и выводились в консоль, а ошибки в отдельный файл. Была организована система сохранения состояния сервера через определенный (заданный) интервал времени и при аварийном завершении работы сервера, при следующем запуске система возобновляла работу с сохраненной контрольной точки.
## Подготовка системы
1. Необходимо установить менеджер пакетов

   1.1. Установим Python:
    ```
    sudo apt update
    sudo apt install python3
    ```
    1.2. Установим менеджер пакетов Pip:
    ```
   sudo apt install python3-pip 
    ```
    1.3. Через pip установим сам conan, нам нужна первая версия:
    ```
    pip install conan==1.* 
    ```
2. Все небоходимые зависимости прописанны уже в файле **conanfile.txt**:
   - libpqxx - API для работы с PostgreSQL
   - boost - собрание библиотек для с расширенным функционалом
   - catch2 - фреймворк для тестирования

    Перейдите в каталог с файлом **conanfile.txt**, создайте каталог (скажем, build) и внутри каталога build выполните команду в зависимости от типа операционной системы

    Linux:
    ```
    conan install .. -s compiler.libcxx=libstdc++11 -s build_type=Debug
    ```

    Windows:

    ```
    conan install .. --build=missing -s build_type=Debug
    ```
    
3. Установим систему сборки CMAKE:
    ```
    apt install cmake 
    ```
## Сборка и запуск проекта
4. Перейдите в созданный каталок build, в нем должен находиться файл **conanbuildinfo.cmake**, который создался на шаге 2. Для ОС Windows можно собрать проект под нужную IDE, скажем для Visual Studio 16 это делается:
    ```
    cmake ../ -G "Visual Studio 16 2019"
    cmake --build . --verbose
    ```

    Для Linux систем можно просто собрать и запустить проект:
    ```
    cmake -DCMAKE_BUILD_TYPE=Debug ..
    cmake --build . 
    ```
5. Для Linux систем так же предусмотрен сбор проекта в Docker, все нужные параметры для сборки прописаны в **Dockerfile**, сама же сборка может быть выполнена:
    ```
    sudo docker build -t my_http_server .
    ```

    Если мы хотим собрать докер файл заново, не используя данные предыдущей компиляции, то можно запустить миную кэш:
    ```
    sudo docker build --no-cache=True -t my_http_server .
    ```
6. По умолчанию проект запускается на порту 8080, но при запуске докера можно сделать перенаправление на любой другой порт, скажем на стандартный 80:
    ```
    sudo docker run --rm -p 80:8080 my_http_server
    ```

    Только нужно предварительно разрешить доступ к порту на фаерволе.

7. Дополнительные ключи запуска проекта:
   - -t - время обсчета физики (столкновения, сбор и сдача предметов) в мс, если параметр 0, то сервер будет управляться обновлением времени вручную через API запрос (об этом позднее). Если же t не равен нулю, то ручные запросы через API будут игнорироваться;
   - -c - указывает расположение файла с данными игрового мира;
   - -w - название каталога с frontend части игры;
   - --randomize-spawn-points - опциональный параметр, если он есть, то игровые аватары игрока (собаки) буду появляться при входе в игру в случайном месте игровой локации
   - --state-file - опциональный параметр, указывает куда будет сохранено состояние игрового мира на случай аварийного или преднамеренного отключения. При запуске сервера, если параметр указан и файл не пустой, то сервер продолжит работы с сохраненного состояния;
   - --save-state-period - опциональный параметр, который работает вкупе с **state-file** и означает, в через какой интервал времени произойдет сохранение состояния игры. Если этот параметр не указан, то игра сохранит свое состояние, только при ручном отключении сервера;

8. Запуск проекта для Linux систем:
    ```
    ./build/game_server -t 0 -c data/config.json -w static
    ```

    Для Windows:
    ```
    build\Debug\game_server.exe -t 0 -c data\config.json -w static
    ```
## API и взаимодействие с игрой
9. Все взаимодействие с игрой происходит через frontend который представляет из себя вебсайт, который отправляет на backend запросы к определенным ресурсам. Как уже сказано выше, игра запускается на порту 8080. Ответ от backend на frontend отправляется как JSON.
    - /api/v1/game/join - запрос типа POST с данными **userName:"ИМЯ_ИГРОКА"** и **mapId:"ИДЕНТИФИКАТОР_КАРТЫ"** отправляет запрос на добавление игрока. В ответ сервер отправляет токен игрока для дальнейшего авторизированного взаимодействия с игрой. Пример такого запроса:
      ```
      curl -X POST -H "Content-Type: application/json" -d "{\"userName\": \"King Arthur\", \"mapId\": \"map1\"}" http://127.0.0.1:8080/api/v1/game/join
      ```

        Пример ответа:
        ```
        HTTP/1.1 200 OK
        Content-Type: application/json
        Content-Length: 61
        Cache-Control: no-cache

        {"authToken":"6516861d89ebfff147bf2eb2b5153ae1","playerId":0} 
        ```
    
    - /api/v1/game/players - запрос типа GET на предоставление списка игроков. Обязательное поле должно содержать токен реального игрока. Пример такого запроса:
        ```
        curl -X GET -H "Authorization: Bearer 0d1d907c2fda95f0def794b7157bee7a" http://127.0.0.1:8080/api/v1/game/state
        ```
    
        Пример ответа:
        ```
        HTTP/1.1 200 OK
        Content-Type: application/json
        Content-Length: 75
        Cache-Control: no-cache
    
        {
          "0": {"name": "Harry Potter"},
          "1": {"name": "Hermione Granger"}
        } 
        ```

    - /api/v1/game/state - запрос типа GET на предоставление данных по игрокам: положение, скорость, направление, содержание инвентаря и набранные очки, а так же тип и расположение всех трофеев на карте. Обязательное поле должно содержать токен существующего игрока. Пример такого запроса:
        ```
        curl -X GET -H "Authorization: Bearer 391566621b967c91f3ade29702f55314" http://127.0.0.1:8080/api/v1/game/state
        ```

        Пример ответа:
        ```
        {
           "players":{
              "1":{
                 "pos":[10.5,3.8],
                 "speed":[0.5, 0.],
                 "dir":"L",
                 "bag":[
                    {"id":9, "type":4},
                    {"id":8, "type":4}
                 ],
                 "score": 50
              }
           },
           "lostObjects":{
              "11":{
                 "type":3,
                 "pos":[13.2,17.2]
              }
           }
        }  
        ```
     - /api/v1/game/player/action - запрос типа POST на изменение направления движения аватара текущего игрока. Обязательное поле должно содержать токен текущего игрока и параметр **move**, который соответствует направлению движения (L,R,D,U) или 0, если персонаж останавливается. Пример такого запроса:
        ```
        curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer 2ab1368f36fe0c05160820dc6f94a35e" -d "{\"move\": \"L\"}" http://127.0.0.1:8080/api/v1/game/player/action

        ```
        Если запрос отработался корректно, то придет пустой ответ.
    - /api/v1/game/tick - технический POST запрос на изменение игрового мира. Обязательное поле **timeDelta**, которое указывает в мс сколько времени прошло с прошлого временного интервал, исходя из этого все физические процесы должно пересчитаться. Пример такого запроса:
        ```
        curl -i -X PUT http://127.0.0.1:8080/api/v1/game/tick -H "Content-Type: application/json" -d "{\"timeDelta\":100}"
        ```

        Если запрос отработался корректно, то придет пустой ответ.

10. Если запрос не верно формулирован или имеет не верные параметры, варианты ответа так же разнятся: "400 Bad request", "401 Unauthorized", "403 Forbidden", "404 Not found" и "405 Method Not Allowed" 
